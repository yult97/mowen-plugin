# Popup 首页四卡结构规格（用户主动触发剪藏预览）｜墨问笔记助手

版本：V1.0  
适用：Chrome Extension Popup（420×680）  
核心约束：**打开 Popup 不自动剪藏/不自动抽取；只有用户主动点击后才获取预览与保存。**  
设计风格：奶油底 + 红色主色 + 卡片化 + 轻阴影（与 Options 一致）。

---

## 0. 目标与验收标准

### 0.1 目标
- 首屏不单调：始终展示功能与当前页状态，不出现大面积留白
- 新用户可理解：10 秒内理解插件用途与下一步行动（配置/测试/预览）
- 主动触发：不自动抽取内容，避免无感操作与性能浪费
- 闭环完整：预览 → 保存 → 成功打开笔记（支持拆分、索引、图片策略）

### 0.2 验收标准（必须）
- [ ] 打开 Popup **不触发** Readability/公众号正文解析/图片抓取  
- [ ] 只有点击 `获取预览` 才开始内容抽取  
- [ ] 未配置 Key 时，首页仍展示功能总览，并通过按钮式 CTA 引导配置  
- [ ] 已填 Key 未测试时，提示“建议先测试连接”，不强制阻塞（但预览/保存入口需引导）  
- [ ] 测试成功后，用户可 `获取预览` → `保存到墨问`  
- [ ] 预览区有明确状态机：Idle/Loading/Ready/Saving/Success/Failed  
- [ ] 风格统一：奶油底、红色主按钮、卡片层级清晰

---

## 1. 全局设计风格（Popup）

### 1.1 色彩 Tokens（统一红色体系）
- `bg/default = #FBF5EF`
- `surface/card = #FFFFFF`
- `border/default = #E8E0DA`
- `brand/primary = #BF4045`
- `brand/hover = #A8383D`
- `brand/active = #8F2F33`
- `brand/soft = rgba(191,64,69,0.08)`
- `brand/focus = rgba(191,64,69,0.25)`
- `text/primary = #1F2937`
- `text/secondary = #6B7280`
- `text/disabled = #9CA3AF`
- `text/on-brand = #FFFFFF`

可选弱装饰（提升质感，避免色带）：  
`radial-gradient(circle at 50% 0%, rgba(191,64,69,0.08), transparent 55%)`

### 1.2 排版与间距（推荐值）
- Popup 内边距：左右 16
- 卡片间距：12
- 卡片内边距：16
- 卡片圆角：16
- 主按钮高度：44（圆角 12）
- 次按钮高度：40（或 36）
- 字体层级：
  - 页面标题：18–20 / Semibold
  - 卡片标题：16 / Semibold
  - 正文：14 / Regular
  - 辅助说明：12 / Regular

### 1.3 组件风格
- Card：白底 + 浅描边 + 克制阴影 `0 6px 20px rgba(17,24,39,0.08)`
- Primary Button：brand/primary 填充 + text/on-brand
- Outline Button：brand/primary 描边 + brand/primary 文本
- Switch：On=brand/primary，Off=中性灰
- Pill：中性底色 + 强文案（用于状态）

---

## 2. 页面结构（420×680）

### 2.1 总体布局
- Header（固定）：56px
- Body（可滚动）：四张卡片纵向堆叠
- 保留底部安全区：12px（避免贴底）

### 2.2 四卡排序（从上到下）
1) Card 1：功能总览（Always）  
2) Card 2：状态/行动（Conditional，核心 CTA）  
3) Card 3：快速设置（Always）  
4) Card 4：剪藏预览/操作（主动触发，状态机）

---

## 3. Header（固定）

### 3.1 组件
- 左：产品名 `墨问笔记助手`
- 右：`设置(齿轮)`、`关闭(X)`、（可选）`置顶(pin)`

### 3.2 行为
- 设置：打开 Options 设置页
- 关闭：关闭 Popup
- 置顶（可选）：保持 Popup 常驻（若实现）

---

## 4. Card 1｜功能总览卡（Always）

### 4.1 目的
- 首屏明确能力，作为视觉锚点，避免空与单调
- 同时展示当前页可剪藏性，减少用户困惑

### 4.2 内容
- 标题：`你可以用它做什么`
- 能力列表（icon + 文案）：
  1) `一键剪藏公众号/新闻/博客到墨问`
  2) `图片尽可能抓取上传，失败自动转链接`
  3) `超过 19,000 字自动拆分为多篇`
  4) `公开/私密可控，支持默认设置`
- 分割线
- 当前页信息（行内展示）：
  - `当前页面：` + domain pill（示例：`weixin.qq.com` / `chrome://extensions`）
  - 页面状态：
    - 可剪藏：`可剪藏`
    - 不可剪藏：`该页面不支持剪藏，请打开文章页`

### 4.3 展示条件
- Always 显示（无论 Key 状态如何）

### 4.4 交互（可选）
- domain pill 点击复制当前域名
- 不可剪藏时仅提示，不弹窗打断

---

## 5. Card 2｜状态 / 行动卡（Conditional）

### 5.1 目的
- 明确“下一步做什么”：配置 → 测试 → 获取预览
- 作为第二视觉锚点，减少单调

### 5.2 状态机（3 态）

#### 5.2.1 S2-0｜未配置 Key
触发条件：`settings.apiKey` 为空  
内容：
- 主文案：`还没配置 API Key`
- 描述：`配置后才能创建笔记并上传图片`
- Primary：`去配置 API Key`（跳转 Options）
- Secondary Link：`查看教程`

#### 5.2.2 S2-1｜已填 Key，未测试
触发条件：apiKey 非空且 `lastTestStatus != success`  
内容：
- 主文案：`API Key 已填写`
- 描述：`建议先测试连接，避免保存时失败`
- Primary：`去测试连接`（打开 Options，并定位测试区域）
- Outline/Link：`稍后再说`（关闭提醒，但不触发预览）

#### 5.2.3 S2-2｜测试成功
触发条件：`lastTestStatus == success`  
内容：
- 主文案：`连接正常`
- 描述：`可以开始剪藏当前文章`
- Primary：`获取预览`（触发 Card 4 进入 PreviewLoading）
- Link：`打开测试笔记`（打开 lastTestNoteUrl）

---

## 6. Card 3｜快速设置（Always）

### 6.1 目的
- 首页可操作：让用户觉得“现在就能设置好”
- 不堆配置，只放 2 个高频项 + 1 个摘要

### 6.2 内容
开关 1：`包含图片`（Switch）
- 说明：`开启后会尽量抓取并上传网页图片`

开关 2：`发布公开笔记`（Switch）
- 说明：`关闭则保存为私密`

摘要行：
- `最大内嵌图片数：{settings.maxImages}`
- 右侧：`修改`（Link → 跳 Options 或弹出数字输入）
- 小字：`超出数量的图片会转为可点击链接`

### 6.3 交互规则
- 开关切换即时影响后续预览与保存（无需立即保存到 Options）
- maxImages 不在 Popup 深度编辑，保持轻量：建议跳转 Options 修改

---

## 7. Card 4｜剪藏预览 / 操作（用户主动触发）

### 7.1 关键原则（必须）
- 默认不抽取、不预览、不抓图
- 只有用户点击 `获取预览`（来自 Card 2 或 Card 4）才开始抽取

### 7.2 状态机定义（必须完整）
- `P0 Idle`：未触发预览
- `P1 PreviewLoading`：提取中（可取消）
- `P2 PreviewReady`：预览就绪（可保存/可重新获取）
- `P3 Saving`：保存中（拆分/上传/创建进度）
- `P4 Success`：保存成功（可打开笔记/索引）
- `P5 Failed`：保存失败（可重试/去设置/查看详情）

---

### 7.3 P0 Idle（默认态）
标题：`剪藏预览`  

分支展示：

#### 7.3.1 未配置 Key
- 文案：`完成配置后，可获取预览并保存到墨问`
- Primary：`去配置 API Key`（跳 Options）

#### 7.3.2 已填 Key 未测试
- 文案：`建议先测试连接，确保可以创建笔记`
- Primary：`去测试连接`（跳 Options 定位测试）
- Secondary：`我知道了`（保留在 Idle）

#### 7.3.3 测试成功
- 文案：`点击下方按钮获取预览（不会自动剪藏）`
- Primary：`获取预览`

> 说明：Idle 态不要用 Skeleton（避免暗示“正在自动加载”）

---

### 7.4 P1 PreviewLoading（预览加载中）
文案：`正在提取正文…`  
步骤条（推荐 3 段）：
1) 提取正文  
2) 解析图片  
3) 生成预览  

操作：
- Link：`取消`（回到 Idle；不产生任何后台任务残留）

---

### 7.5 P2 PreviewReady（预览就绪）
展示（信息“够用但不长”）：
- 标题（1–2 行）：文章标题
- 来源 URL（默认折叠）：
  - `来源：{url}`（可点击复制/打开）
- 指标 chips：
  - `字数：≈ {wordCount}`
  - `图片：{imageCount}`
  - `将内嵌：{maxImages}`
  - `将转链接：{imageCount - maxImages（>=0）}`

轻量选项（不堆）：
- `处理模式`（单选）：
  - `一键剪藏`（默认）
  - `AI 智能整理`（占位/灰，P1 以后再做）

预览内容（可折叠）：
- 默认展示 6–10 行摘要 + `展开预览`
- 展开后最多渲染前 2–3 屏（避免长文卡顿）

操作区：
- Primary：`保存到墨问`
- Outline：`重新获取预览`

---

### 7.6 P3 Saving（保存中）
主文案：`正在保存到墨问…`  

步骤与进度（必须可理解）：
1) `创建笔记（{partIndex}/{partTotal}）`
2) `上传图片（{uploaded}/{planned}）`
3) `设置公开/私密`

交互：
- Link：`查看详情`（展开日志摘要）
- Link：`取消`（可选；说明：可能已创建部分笔记，无法完全回滚）

---

### 7.7 P4 Success（保存成功）
主文案：`保存成功`  

分支：
- 单篇：
  - Primary/Link：`打开笔记`
- 多篇拆分：
  - 列表：`第 1 篇 / 第 2 篇 / ...`（每项可打开）
  - 若开启索引：
    - Primary：`打开索引笔记`

辅助：
- `继续保存其它页面`（可选，仅提示即可）

---

### 7.8 P5 Failed（保存失败）
主文案：`保存失败：{可理解原因}`  
操作：
- Primary：`重试保存`
- Outline：`重新获取预览`
- Link：`去设置`（Key/权限/配置相关错误时）
- Link：`查看详情`（展开错误码、原始 message）

错误原因映射（建议）：
- Key 无效：`API Key 无效或已过期，请重新生成。`
- 网络异常：`网络异常，请稍后再试。`
- 频率限制：`请求过于频繁，请稍后再试。`
- 其他：`保存失败，请重试。`

---

## 8. 展示条件与按钮跳转规则（汇总）

### 8.1 “获取预览”按钮出现条件
- `lastTestStatus == success`
- 且 `当前页面可剪藏 == true`（可选严格要求；若 false 则提示不可剪藏）

### 8.2 “保存到墨问”按钮启用条件
- 当前状态为 `PreviewReady`
- 已生成 preview 数据（title/contentHtml/blocks/images）

### 8.3 跳转与定位
- `去配置 API Key`：打开 Options，并定位到 API Key 输入框
- `去测试连接`：打开 Options，并定位到测试连接区域（高亮）
- `打开测试笔记`：打开 lastTestNoteUrl（新 Tab）

---

## 9. 性能与实现约束（防止自动剪藏）

### 9.1 Popup 初始化允许做的事
- 读取 settings（storage）
- 获取当前 tab 的 URL、domain、可剪藏性判断（轻量）
- 渲染四卡（不触发抽取）

### 9.2 Popup 初始化禁止做的事
- 禁止注入 content script 做 Readability
- 禁止抓取正文 DOM
- 禁止发起图片下载/上传

### 9.3 用户点击后才允许
- 点击 `获取预览`：
  - 注入/唤起 content script
  - 执行抽取（公众号定向 + Readability）
  - 解析图片候选列表（不下载图片）
  - 生成预览数据回传给 Popup

- 点击 `保存到墨问`：
  - 进入保存流程：拆分（19,000 阈值）→ 创建笔记 → 图片抓取上传（<= maxImages）→ 超额转链接 → 设置公开/私密 → （可选）索引笔记

---

## 10. 文案清单（可直接用）

- 功能总览标题：你可以用它做什么
- 当前页面：当前页面：
- 不可剪藏提示：该页面不支持剪藏，请打开文章页

- 未配置 Key：还没配置 API Key
- 未配置说明：配置后才能创建笔记并上传图片
- CTA：去配置 API Key

- 已填未测：API Key 已填写
- 建议测试：建议先测试连接，避免保存时失败
- CTA：去测试连接
- 次按钮：稍后再说

- 测试成功：连接正常
- CTA：获取预览
- 预览说明：点击下方按钮获取预览（不会自动剪藏）

- 预览标题：剪藏预览
- 保存按钮：保存到墨问
- 重新预览：重新获取预览

- 保存成功：保存成功
- 打开笔记：打开笔记
- 打开索引笔记：打开索引笔记

- 保存失败：保存失败：
- 重试保存：重试保存
- 查看详情：查看详情
- 去设置：去设置

---

## 11. 设计补充建议（减少单调但不堆叠）
- icon 统一加浅红底容器（brand/soft）增强秩序感
- Card 2（状态/行动）内部可加一个小 Pill（如“未测试/已验证”），提升层次
- Card 4 Idle 用“空态 icon”点缀，但要克制
- 首屏至少出现两张卡（Card1+Card2），避免“只有一个按钮”感
