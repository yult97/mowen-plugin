# PRD：墨问笔记助手 — AI 语音笔记（Typeless 风格）

> 交付目标：把「录音交互 + 编辑区域」完整搭建出来（前端先跑通），包含实时吐字、修订可感知、结束后编辑与保存流程。  
> UI 参数：**与现有插件 UI 参数规范保持一致**（主色、圆角、字号、间距、按钮风格全部沿用现有组件/Token，不在本 PRD 内重新定义数值）。

---

## 1. 背景与目标

### 1.1 背景
用户希望在浏览器插件内完成「语音 → 实时文字 → 可编辑 → 保存到墨问」的闭环。现有方案多为录完再转写，反馈慢；本功能交互参考 Typeless：**说话时就能看到文字流动，同时能看到系统对刚刚文字的修订**，录音结束后可继续编辑并保存。

### 1.2 目标
- 录音中：实现**实时吐字**（Partial）与**确认文本**（Final）并存。
- 录音中：出现**修订行为可感知**（例如：上一段被替换、纠错、补标点）。
- 录音结束：自动整理为可编辑内容，支持用户修订并保存到墨问。
- UI：完全沿用现有插件的主色、字体体系、圆角、按钮组件、提示样式，保证一致性。

### 1.3 非目标（本期不做）
- 说话人分离、多角色对话结构化（可预留）。
- 复杂富文本编辑器（先用轻量编辑；后续再升级 ProseMirror/Tiptap）。
- 多语言自动识别（本期默认中文，后续再扩展）。
- 后端 ASR 通道的真实实现（本期允许先用 Mock 跑通；接口仅占位）。

---

## 2. 用户画像与使用场景

### 2.1 用户画像
- 需要快速记录想法、会议要点、读文章的语音感想。
- 期望“边说边出字”，可随时停/改/续，不想等。

### 2.2 典型场景
1) 打开插件 → 点「AI 语音笔记」→ 录音 → 实时出字 → 结束 → 轻编辑 → 保存墨问  
2) 录音过程中说错 → 继续说 → 系统自动修订上一句（用户能看见“被修订”）  
3) 弱网/ASR 波动 → UI 仍给出明确状态与可恢复路径（不丢字）

---

## 3. 核心体验定义（Typeless 风格）

### 3.1 三层文本
- **吐字层（Partial / 临时）**：正在生成的字，可能随时变化。展示为弱强调（浅色/次级文本样式，按现有 UI Token）。
- **确认层（Final / 已确认）**：模型锁定的文本，展示为正文样式。
- **修订层（Revision / 修订提示）**：当模型改写上一段时，用户能看见“刚刚被改了什么”。

### 3.2 修订必须可感知（不可静默替换）
当发生“上一段被替换”时，至少满足以下组合：
- **A. 被改动区域短暂高亮**（推荐 0.6–1.0s，使用现有提示高亮/弱底色风格）
- **B. 在段尾显示「已修订」小提示**（3s 后淡出）
- （后续增强）C. 提供“查看改动”入口（展开前后对比）

> 本期执行：A + B（成本低、感知强）。

---

## 4. 信息架构与页面结构

### 4.1 入口
- 插件首页新增入口按钮：**AI 语音笔记**

### 4.2 页面模块
1) 顶部栏：标题「AI 语音笔记」+ 返回/关闭  
2) 状态条（关键）：  
   - 录音中：红点 + “录音中 00:32”  
   - 暂停：灰点 + “已暂停”  
   - 整理中：loading + “整理中…”  
3) 转写展示区（录音中主视图）：Final + Partial + 修订提示  
4) 编辑区（结束后主视图）：可编辑文本（默认带段落分隔）  
5) 底部操作区：  
   - 录音中：暂停 / 结束（主按钮）  
   - 暂停中：继续 / 结束  
   - 编辑中：保存到墨问（主按钮）/ 继续补录（次按钮）/ 取消

---

## 5. 用户流程（端到端）

### 5.1 首次使用
1) 点击「AI 语音笔记」
2) 触发麦克风权限弹窗
3) 授权成功后开始录音（建议：授权成功即自动开始；若失败则给出引导文案）

### 5.2 录音 → 实时转写（核心）
- 用户说话 → 展示 Partial（吐字）
- 模型确认后 → Partial 的一部分转为 Final（确认文本累积）
- 模型回改上一句 → 触发修订提示（高亮被改区域 + 段尾“已修订”）

### 5.3 暂停/继续
- 暂停：停止发送音频；状态变“已暂停”
- 继续：恢复发送音频；状态回“录音中”

### 5.4 结束 → 整理 → 编辑 → 保存
- 点击「结束」：停止录音与转写
- 进入“整理中…”（短暂过渡）
- 自动进入编辑态：合并 Final + 最后 Partial
- 用户编辑后点击「保存到墨问」
- 保存成功：展示主色一致的提示 **「已保存」**（1.5s 自动消失）
- 保存失败：展示错误提示 + “重试”

### 5.5 继续补录（本期支持：追加到末尾）
- 编辑态提供「继续补录」
- 点击后回到录音态，新增内容**追加到末尾**
- UI 需要明确提示“将追加到末尾”（使用现有提示样式）

---

## 6. 状态机与前端实现约束（开发执行要点）

### 6.1 状态机
- `idle`：未开始
- `recording`：录音中 + 流式转写中
- `paused`：暂停
- `finalizing`：结束后整理
- `editing`：编辑态
- `saving`：保存中
- `done`：已保存（短暂提示态）

允许跳转：
- idle → recording
- recording ↔ paused
- recording/paused → finalizing → editing
- editing ↔ recording（继续补录）
- editing → saving → done（done 自动回 editing）

### 6.2 文本渲染数据模型（三份数据）
- `finalTextBlocks`: string[]（按段落存储）
- `partialText`: string（当前临时吐字，仅一段）
- `revisionMark`: { blockIndex: number, ts: number } | null（用于触发高亮/提示）

展示规则：
- Final 区：渲染 `finalTextBlocks`
- Partial 区：渲染 `partialText`，跟在 Final 后
- 修订发生：命中的段落高亮 0.8s + 段尾“已修订”提示（3s 淡出）

### 6.3 修订事件定义（后端/Mock 统一）
前端需支持三类事件（真实 ASR 不一定都给，但前端必须预留）：
- `partial(fullPartialText)`：覆盖更新吐字
- `final(appendText)`：追加确认文本
- `revise(targetBlockIndex, newText)`：替换某段 Final 文本

> 本期：用 MockASR 生成上述事件，先把 Typeless 感做出来；后续接真实 ASR 只替换事件源。

### 6.4 段落切分策略
- `final()` 追加内容后：若包含 `\n\n`，按空行切段
- 若无空行：按中文标点（。！？；）+ 字数阈值进行软分段（例如 60–120 字之间，具体数值可复用现有段落策略）
- Partial 永远只显示在最后，不插入中间

---

## 7. UI/交互规范（不改现有参数，仅按现有风格实现）

### 7.1 视觉一致性要求
- 主色、圆角、阴影、字号、间距、按钮高度/字重：**必须复用现有组件/Token**
- 状态提示（红点、loading、成功提示）：必须与现有“保存到墨问/已保存”反馈体系一致

### 7.2 按钮与反馈（必须）
- 录音态：主按钮「结束」；次按钮「暂停」
- 暂停态：主按钮「继续」；次按钮「结束」
- 编辑态：主按钮「保存到墨问」；次按钮「继续补录」

保存反馈：
- 保存中：主按钮 loading + 禁用其他操作
- 成功：显示主色提示条/胶囊 **「已保存」**，1.5s 自动消失
- 失败：错误提示 + “重试”，并保留编辑内容不丢失

---

## 8. 功能需求清单（验收项）

### 8.1 录音与权限
- [ ] 首次进入请求麦克风权限
- [ ] 权限失败：提示如何开启权限（清晰、可操作）
- [ ] 录音计时显示正常
- [ ] 暂停/继续切换正常

### 8.2 实时吐字（Partial）
- [ ] 吐字在 200–500ms 内可见更新（Mock 也要达到）
- [ ] Partial 覆盖更新，不出现重复叠字
- [ ] Final 累积不丢字

### 8.3 修订可见（Revision）
- [ ] revise 发生时：被修订段落高亮 0.6–1.0s
- [ ] 段尾显示“已修订”提示并自动淡出

### 8.4 结束整理与编辑
- [ ] 结束后出现“整理中…”过渡
- [ ] 编辑内容 = Final + 最后 Partial（若存在）
- [ ] 编辑支持复制/粘贴（基础编辑即可）

### 8.5 保存到墨问（占位对接）
- [ ] 保存成功：提示“已保存”（主色一致）
- [ ] 保存失败：提示原因 + 支持重试
- [ ] 保存过程中不允许重复点击导致多次提交

---

## 9. 接口与数据（本期允许占位 / Mock）

### 9.1 ASR 流式通道（占位）
协议：WebSocket / WebRTC / SSE 由后端决定。  
前端只要求：能持续收到 `partial/final/revise` 事件（格式可按 6.3）。

### 9.2 保存到墨问
复用现有 note/create 流程：
- 输入：编辑态最终文本
- 输出：创建/更新笔记成功提示

> 本期若后端未接入，可先用假接口/本地存储模拟保存成功，用于打磨交互与状态。

---

## 10. 埋点与日志（建议）
- 进入语音笔记页
- 麦克风授权成功/失败
- 开始/暂停/继续/结束次数
- 平均录音时长
- 保存成功/失败
- revise 触发次数（评估 Typeless 修订感）

---

## 11. 风险与对策
1) 真实 ASR 不提供 revise  
- 对策：前端先预留 revise 处理；后续可引入后处理模型生成 revise（不在本期范围）

2) Partial 更新太频繁造成闪烁  
- 对策：Partial 更新节流（例如 200ms）+ 差量渲染

3) 长文本渲染性能  
- 对策：按段落渲染；必要时引入虚拟滚动（后续）

---

## 12. 交付物与对 AI 开发的执行要求（直接照做）
### 12.1 必须交付
- React 页面/组件：语音笔记页（含状态条、转写展示区、编辑区、底部按钮）
- 状态机实现：按 6.1
- MockASR：可模拟 `partial/final/revise`，用于本地跑通与 UI 打磨
- ASR 事件源抽象：`ITranscriber`（Mock 与真实实现可替换）
- 保存动作抽象：`INoteSaver`（Mock 与真实墨问接口可替换）

### 12.2 代码约束
- 组件拆分：转写展示区与编辑区分离
- 所有 UI 样式：复用现有组件/Token；禁止引入新的设计体系
- 错误/异常：必须可见并可恢复（不丢字，不清空编辑区）

---

## 13. 最小验收用例（必须通过）
1) 录音 10 秒：实时出字；结束后进入编辑态；内容完整  
2) revise 模拟：上一句被替换；高亮+“已修订”出现  
3) 暂停 5 秒：文字停止更新；继续后恢复  
4) 保存成功：出现“已保存”提示；按钮恢复可点  
5) 保存失败：提示失败原因；可重试；文本不丢失  

---

**版本**：v1.0（前端 UI + MockASR 先行）  
**备注**：后端 ASR 通道与真实对接在后续版本推进，本 PRD 已为其预留事件模型与接口抽象。
